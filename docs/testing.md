# Тестирование MCP Finance Agent

## Обзор

Система тестирования MCP Finance Agent включает в себя несколько уровней:

1. Unit тесты для отдельных компонентов
2. Интеграционные тесты для проверки взаимодействия компонентов
3. End-to-end тесты для проверки полного потока работы

## Структура тестов

```
tests/
├── unit/                  # Unit тесты компонентов
│   ├── agent/            # Тесты базовых компонентов агента
│   │   ├── tools/        # Тесты инструментов
│   │   └── ...
│   └── services/         # Тесты сервисов
├── integration/          # Интеграционные тесты
│   ├── conftest.py      # Общие фикстуры
│   └── test_*.py        # Тесты потоков
└── e2e/                 # End-to-end тесты (будут добавлены позже)
```

## Компоненты и их тесты

### Context Manager
- `test_context.py`: Тесты управления контекстом
  - Сохранение и загрузка контекста
  - Управление сообщениями
  - Работа с метаданными

### Tool Registry
- `test_registry.py`: Тесты реестра инструментов
  - Регистрация инструментов
  - Поиск по типу
  - Валидация конфигурации

### Message Handler
- `test_message_handler.py`: Тесты обработчика сообщений
  - Обработка входящих сообщений
  - Выбор инструментов
  - Генерация ответов

### Message Analyzer
- `test_message_analyzer.py`: Тесты анализатора сообщений
  - Определение типов инструментов
  - Паттерны сообщений
  - Приоритизация инструментов

### Tool Base & Executor
- `test_base.py`: Тесты базового класса инструментов
  - Валидация конфигурации
  - Извлечение параметров
- `test_executor.py`: Тесты исполнителя инструментов
  - Выполнение инструментов
  - Обработка ошибок
  - Контекст выполнения

## Интеграционные тесты

### Message Flow
- `test_message_flow.py`: Тесты полного потока обработки сообщений
  - Запросы портфеля
  - Анализ рисков
  - Множественные инструменты
  - Сохранение контекста
  - Обработка ошибок

## Запуск тестов

### Локальное окружение

```bash
# Установка зависимостей
poetry install

# Запуск всех тестов
poetry run pytest

# Запуск определенной категории тестов
poetry run pytest tests/unit/
poetry run pytest tests/integration/

# Запуск с покрытием
poetry run pytest --cov=src
```

### CI/CD

Тесты автоматически запускаются в CI/CD пайплайне при:
- Создании Pull Request
- Мерже в main ветку
- Создании релиза

## Мокирование

В тестах используются следующие моки:
- Redis для хранения контекста
- Внешние API (Tinkoff API)
- Тестовые инструменты

## Добавление новых тестов

При добавлении новых компонентов необходимо:
1. Создать unit тесты для нового компонента
2. Обновить интеграционные тесты
3. Добавить необходимые фикстуры
4. Обновить документацию

## Best Practices

1. Каждый тест должен быть независимым
2. Использовать фикстуры для переиспользуемого кода
3. Тесты должны быть читаемыми и понятными
4. Комментировать сложную логику
5. Следить за покрытием кода
6. Регулярно обновлять моки и фикстуры 